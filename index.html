<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML-Writer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ext-beautify.js" type="text/javascript" charset="utf-8"></script>
    <style>
        body {
            height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
        }
        #main {
            display: flex;
            flex-grow: 1;
        }
        #toolbar {
            padding: 5px;
            background: #333;
            color: white;
            overflow-x: auto;
        }
        #toolbar button {
            background: #555;
            color: white;
            border: none;
            padding: 5px 10px;
            margin-right: 5px;
            cursor: pointer;
        }
        #toolbar .info-saved {
            float: right;
        }
        #toolbar button:hover {
            background: #3e787a;
        }
        #editor-container {
            width: 50%;
            height: 100%;
        }
        #editor {
            width: 100%;
            height: 100%;
        }
        #preview-container {
            height: 100%;
            width: 50%;
            overflow: auto;
            position: relative;
        }
        #preview {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>

<div id="toolbar">
    <button onclick="beautifyCode();">Beautify</button>
    <button onclick="printPreview();">Print</button>
    <button onclick="saveFile();">Save</button>
    <button onclick="loadFile();">Load</button>
    <input type="file" id="fileInput" accept=".html" style="display:none;" onchange="handleFileLoad(event)">
    <span class="info-saved">cached at <span class="value"></span></span>
</div>
<div id="main">

    <!-- Code Editor (Ace) -->
    <div id="editor-container">
        <div id="editor"></div>
    </div>

    <!-- Live Preview (Editable + Drag-and-Drop) -->
    <div id="preview-container">
        <iframe id="preview"></iframe>
    </div>
</div>

    <script>
        const dbName = 'htmlWriterDatabase';
        const cacheTime = document.querySelector('.info-saved .value');
        // Initialize Ace Editor
        let htmlContent = "";
        const editor = ace.edit("editor");
        const beautify = ace.require("ace/ext/beautify"); // get reference to extension
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/html");
        editor.getSession().setOption("wrap", true);

        var previewFrame = document.getElementById("preview");
        var previewDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;

        // Initialize IndexedDB
        // const dbName = "htmlEditorDB";
        const storeName = "editorContent";
        // let db;

        const request = indexedDB.open(dbName, 1);
        request.onerror = function (event) {
            console.error("Error opening IndexedDB:", event);
        };
        request.onsuccess = function (event) {
            db = event.target.result;
            loadContentFromDB();
        };
        request.onupgradeneeded = function (event) {
            db = event.target.result;
            db.createObjectStore(storeName, { keyPath: "id" });
        };

        function updatePreview() {
            const scrollY = previewFrame.contentWindow.scrollY;
            previewDoc.open();
            previewDoc.write(editor.getValue());
            previewDoc.close();

            var previewBody = previewDoc.body;
            previewBody.scrollTop = scrollY;
        }

        function printPreview() {
            previewFrame.contentWindow.focus(); // Ensure the iframe is focused
            previewFrame.contentWindow.print(); // Print the iframe content
        }

        function beautifyCode() {
            beautify.beautify(editor.session);
        }

        function saveFile() {
            const content = editor.getValue();
            const blob = new Blob([content], { type: "text/html" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "myfile.html";
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function loadFile() {
            document.getElementById("fileInput").click();
        }

        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                editor.setValue(e.target.result, -1);
                updatePreview();
            };
            reader.readAsText(file);
        }

        function loadContentFromDB() {
            const transaction = db.transaction([storeName], "readonly");
            const store = transaction.objectStore(storeName);
            const getRequest = store.get(1); // ID 1 for the first entry

            getRequest.onsuccess = function (event) {
                const data = event.target.result;
                if (data) {
                    htmlContent = data.content;
                    editor.setValue(htmlContent, -1);
                    updatePreview();
                }
            };
        }

        function cacheContent() {
            const content = editor.getValue();
            const transaction = db.transaction([storeName], "readwrite");
            const store = transaction.objectStore(storeName);

            store.put({ id: 1, content: content });

            const currentDate = new Date();
            cacheTime.innerText = currentDate.toLocaleString();
        }

        setInterval(cacheContent, 10000);

        // Auto-save on page close or when hidden
        window.addEventListener("beforeunload", () => { cacheContent(); });
        document.addEventListener("visibilitychange", () => {
            if (document.hidden) {
                cacheContent();
            }
        });

        editor.session.on("change", function () {
            updatePreview();
        });

        updatePreview();
    </script>

</body>
</html>
