<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML-Writer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ext-beautify.js" type="text/javascript" charset="utf-8"></script>
    <style>
        body {
            height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
        }
        #main {
            display: flex;
            flex-grow: 1;
        }
        #toolbar {
            padding: 5px;
            background: #333;
            color: white;
        }
        #toolbar button {
            background: #555;
            color: white;
            border: none;
            padding: 5px 10px;
            margin-right: 5px;
            cursor: pointer;
        }
        #toolbar .info-saved {
            float: right;
        }
        #toolbar button:hover {
            background: #3e787a;
        }
        #editor-container {
            width: 50%;
            height: 100%;
        }
        #editor {
            width: 100%;
            height: 100%;
        }
        #preview-container {
            height: 100%;
            width: 50%;
            overflow: auto;
            position: relative;
        }
        #preview {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    
    <div id="toolbar">
        <button onclick="beautifyCode();">Beautify</button>
        <button onclick="printPreview();">Print</button>
        <button onclick="saveFile();">Save</button>
        <button onclick="loadFile();">Load</button>
        <input type="file" id="fileInput" accept=".html" style="display:none;" onchange="handleFileLoad(event)">
        <span class="info-saved">cached at <span class="value"></span></span>
    </div>
    <div id="main">
        
        <!-- Code Editor (Ace) -->
        <div id="editor-container">
            <div id="editor"></div>
        </div>
        
        <!-- Live Preview (Editable + Drag-and-Drop) -->
        <div id="preview-container">
            <iframe id="preview"></iframe>
        </div>
    </div>
    
    <script>
        const cacheTime = document.querySelector('.info-saved .value');
        // Initialize Ace Editor
        let htmlContent = localStorage.getItem('ace-local-editor-html-content');
        const editor = ace.edit("editor");
        const beautify = ace.require("ace/ext/beautify"); // get reference to extension
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/html");
        editor.getSession().setOption("wrap", true);
        editor.setValue(htmlContent ?? `<html>
<head>
    <style>
        
    </style>
</head>
<body>
        
</body>
</html>`, -1);
        const previewFrame = document.getElementById("preview");
        const previewDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
        function updatePreview() {
            const scrollY = previewFrame.contentWindow.scrollY || previewFrame.contentDocument.documentElement.scrollTop;
            previewDoc.open();
            previewDoc.write(editor.getValue());
            previewDoc.close();
            
            
            // Wait for the preview to load and update the body reference
            setTimeout(() => {
                previewBody = previewDoc.body;
            }, 50);
        }
        
        function printPreview() {
            previewFrame.contentWindow.focus(); // Ensure the iframe is focused
            previewFrame.contentWindow.print(); // Print the iframe content
        }
        
        
        function beautifyCode() {
            beautify.beautify(editor.session);
        }
        
        function saveFile() {
            const content = editor.getValue();
            const blob = new Blob([content], { type: "text/html" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "myfile.html";
            a.click();
            URL.revokeObjectURL(a.href);
        }
        
        function loadFile() {
            document.getElementById("fileInput").click();
        }
        
        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function (e) {
                editor.setValue(e.target.result, -1);
                updatePreview();
            };
            reader.readAsText(file);
        }
        
        editor.session.on("change", function () {
            updatePreview();
        });

        function cacheContent() {
            localStorage.setItem('ace-local-editor-html-content', editor.getValue());
            
            const currentDate = new Date();
            cacheTime.innerText = currentDate.toLocaleString();
        }
        
        setInterval(cacheContent(), 10000);

        // Auto-save on page close or when hidden
        window.addEventListener("beforeunload", () => {cacheContent();});
        document.addEventListener("visibilitychange", () => {
            if(document.hidden) {
                cacheContent();
            }
        });

        
        updatePreview();
    </script>
    
</body>
</html>